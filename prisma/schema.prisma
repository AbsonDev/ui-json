// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Auth Models (NextAuth v5 compatible)
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String // hashed with bcrypt
  image         String?
  isAdmin       Boolean   @default(false)

  // Freemium fields
  planTier         PlanTier @default(FREE)
  stripeCustomerId String?  @unique

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts           Account[]
  sessions           Session[]
  apps               App[]                // Apps created by user
  databaseConnections DatabaseConnection[] // Database connections owned by user
  subscriptions      Subscription[]       // User subscriptions
  usageMetrics       UsageMetric[]        // Usage tracking
  invoices           Invoice[]            // Billing invoices
  emailLogs          EmailLog[]           // Email communication logs
  aiUsage            AIUsage[]            // AI request tracking (for editor)
  aiDailyLimits      AIDailyLimit[]       // AI daily limit tracking (for editor)
  appAIUsage         AppAIUsage[]         // AI usage in client apps
  aiExecutionLimits  AIExecutionLimit[]   // AI execution limits for client apps

  @@index([email, isAdmin]) // Composite index for admin queries
  @@index([createdAt]) // Index for sorting by creation date
  @@index([planTier]) // Index for plan-based queries
  @@index([stripeCustomerId]) // Index for Stripe lookups
  @@map("users")
}

// Plan tier enumeration
enum PlanTier {
  FREE
  PRO
  TEAM
  ENTERPRISE
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId]) // Index for user account lookups
  @@index([userId, provider]) // Composite index for provider-specific queries
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId]) // Index for user session lookups
  @@index([expires]) // Index for expired session cleanup
  @@index([userId, expires]) // Composite index for active user sessions
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// UI-JSON App Models
// ============================================

model App {
  id          String   @id @default(cuid())
  name        String
  json        String   @db.Text // UI-JSON definition
  description String?
  isPublic    Boolean  @default(false)
  version     String   @default("1.0.0")

  // Database configuration
  useLocalStorage      Boolean            @default(true)
  databaseConnectionId String?
  databaseConnection   DatabaseConnection? @relation(fields: [databaseConnectionId], references: [id], onDelete: SetNull)

  // Database state for this app (usado quando useLocalStorage = true)
  databaseData Json?    // Stores the dynamic database content

  // Publishing & Analytics
  publishedAt    DateTime? // When the app was published
  publishedSlug  String?   @unique // Custom URL slug (e.g., "my-todo-app")
  viewCount      Int       @default(0) // Total views
  lastViewedAt   DateTime? // Last time someone viewed this published app

  // Watermark control (PRO+ can remove)
  showWatermark  Boolean   @default(true)

  // Ownership
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Mobile builds
  builds      Build[]

  // AI usage in this app
  appAIUsage  AppAIUsage[]

  // Published app views
  appViews    AppView[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([databaseConnectionId])
  @@index([userId, isPublic]) // Composite index for public app queries
  @@index([userId, updatedAt]) // Composite index for recently updated apps
  @@index([userId, createdAt]) // Composite index for recently created apps
  @@index([isPublic, createdAt]) // Index for public app discovery
  @@index([useLocalStorage]) // Index for storage type queries
  @@index([publishedSlug]) // Index for published app lookups
  @@map("apps")
}

// ============================================
// Database Connection Models
// ============================================

model DatabaseConnection {
  id          String   @id @default(cuid())
  name        String   // "Production DB", "Staging DB"

  // Connection details
  type        String   @default("postgresql") // postgresql, mysql, mongodb
  host        String
  port        Int      @default(5432)
  database    String
  username    String
  password    String   // encrypted with AES-256!
  ssl         Boolean  @default(false)

  // Status
  isActive    Boolean  @default(true)
  lastTestedAt DateTime?
  lastTestStatus String? // "success", "failed"
  lastTestError  String?

  // Ownership
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Apps using this connection
  apps        App[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
  @@index([userId, isActive]) // Composite index for active user connections
  @@index([userId, type]) // Composite index for type-specific queries
  @@index([lastTestedAt]) // Index for connection health monitoring
  @@map("database_connections")
}

// ============================================
// Mobile Build Models
// ============================================

model Build {
  id            String   @id @default(cuid())

  // Build configuration
  platform      String   // "android" | "ios"
  buildType     String   // "debug" | "release"
  status        String   // "pending" | "building" | "success" | "failed"

  // App configuration for this build
  bundleId      String   // com.myapp.myproject
  appVersion    String   // 1.0.0
  versionCode   Int      // 1, 2, 3...
  appName       String   // Name of the app at build time

  // Build output
  downloadUrl   String?  // URL to download AAB/IPA
  fileSize      Int?     // File size in bytes
  fileName      String?  // app-release.aab

  // Error info (if failed)
  error         String?  @db.Text
  errorDetails  String?  @db.Text

  // Build metadata
  buildDuration Int?     // Duration in seconds
  completedAt   DateTime?

  // Relation to app
  appId         String
  app           App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([appId])
  @@index([status])
  @@index([platform])
  @@index([appId, status]) // Composite index for app build status queries
  @@index([appId, createdAt]) // Composite index for recent builds
  @@index([appId, platform, status]) // Composite index for platform-specific queries
  @@index([status, createdAt]) // Index for global build monitoring
  @@map("builds")
}

// ============================================
// Subscription & Billing Models
// ============================================

model Subscription {
  id                    String   @id @default(cuid())

  // Stripe IDs
  stripeSubscriptionId  String   @unique
  stripePriceId         String
  stripeProductId       String

  // Subscription details
  planTier              PlanTier
  status                SubscriptionStatus

  // Billing cycle
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean  @default(false)
  canceledAt            DateTime?

  // Pricing
  amount                Int      // in cents (e.g., 1900 = $19.00)
  currency              String   @default("usd")
  interval              BillingInterval

  // Trial
  trialStart            DateTime?
  trialEnd              DateTime?

  // Metadata
  metadata              Json?

  // User relation
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([userId, status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  UNPAID
}

enum BillingInterval {
  MONTH
  YEAR
}

model UsageMetric {
  id          String   @id @default(cuid())

  // User relation
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Metrics tracking
  appsCount           Int      @default(0)
  buildsCount         Int      @default(0)
  exportsCount        Int      @default(0)
  templatesUsedCount  Int      @default(0)
  apiCallsCount       Int      @default(0)
  storageUsedMB       Float    @default(0)

  // Period tracking
  periodStart         DateTime
  periodEnd           DateTime

  // Reset tracking
  resetAt             DateTime?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId])
  @@index([userId, periodEnd])
  @@index([periodEnd])
  @@map("usage_metrics")
}

model Invoice {
  id                  String   @id @default(cuid())

  // Stripe data
  stripeInvoiceId     String   @unique
  stripePaymentIntentId String?

  // Invoice details
  amount              Int      // in cents
  currency            String   @default("usd")
  status              InvoiceStatus

  // URLs
  hostedInvoiceUrl    String?
  invoicePdf          String?

  // Dates
  periodStart         DateTime
  periodEnd           DateTime
  dueDate             DateTime?
  paidAt              DateTime?

  // User relation
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId])
  @@index([stripeInvoiceId])
  @@index([status])
  @@index([userId, createdAt])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

model PlanConfig {
  id          String   @id @default(cuid())

  planTier    PlanTier @unique

  // Feature limits
  maxApps             Int      // -1 for unlimited
  maxBuilds           Int      // per month
  maxExports          Int      // per month
  maxTemplates        Int      // -1 for all
  maxApiCalls         Int      // per month
  maxStorageMB        Int

  // Feature flags
  customDomain        Boolean  @default(false)
  prioritySupport     Boolean  @default(false)
  removeWatermark     Boolean  @default(false)
  teamCollaboration   Boolean  @default(false)
  analytics           Boolean  @default(false)
  versionHistory      Boolean  @default(false)
  aiAssistant         Boolean  @default(false)

  // Pricing
  priceMonthly        Int?     // in cents
  priceYearly         Int?     // in cents

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("plan_configs")
}

// ============================================
// Email Tracking
// ============================================

model EmailLog {
  id          String   @id @default(cuid())
  userId      String
  emailType   String   // e.g., "trial_day_1", "trial_day_4", etc.
  subject     String
  sentAt      DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([emailType])
  @@index([userId, emailType])
  @@index([sentAt])
  @@map("email_logs")
}

// ============================================
// AI Usage Tracking
// ============================================

model AIUsage {
  id          String   @id @default(cuid())

  // User relation
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Request details
  prompt      String   @db.Text
  jsonBefore  String?  @db.Text // JSON state before AI modification
  jsonAfter   String?  @db.Text // JSON generated by AI

  // AI response metadata
  model       String   @default("gemini-2.5-flash")
  tokensUsed  Int?
  responseTime Int?    // in milliseconds

  // Success tracking
  wasSuccessful Boolean @default(false) // Was valid JSON generated?
  wasAccepted   Boolean @default(false) // Did user accept the suggestion?
  errorMessage  String? @db.Text

  // Categorization
  category    AIRequestCategory @default(MODIFY)

  // Timestamps
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([category])
  @@index([wasSuccessful])
  @@index([wasAccepted])
  @@index([userId, category])
  @@map("ai_usage")
}

enum AIRequestCategory {
  CREATE      // Creating new app from scratch
  MODIFY      // Modifying existing JSON
  DATABASE    // Database schema operations
  AUTH        // Authentication setup
  COMPONENT   // Adding/modifying components
  SCREEN      // Adding/modifying screens
}

// ============================================
// AI Daily Limits Tracking
// ============================================

model AIDailyLimit {
  id          String   @id @default(cuid())

  // User relation
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Daily tracking
  date        DateTime @default(now()) @db.Date
  requestCount Int     @default(0)
  maxRequests  Int     // Based on user's plan tier

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
  @@index([date])
  @@map("ai_daily_limits")
}

// ============================================
// AI Usage in Client Apps
// ============================================

model AppAIUsage {
  id          String   @id @default(cuid())

  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  appId       String
  app         App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  // AI execution details
  aiAction    String   // "chat", "analyze", "suggest", "classify", "generate"
  prompt      String   @db.Text
  result      String   @db.Text

  // Context (formData, etc)
  context     String?  @db.Text

  // Performance metrics
  tokensUsed  Int?
  responseTime Int?    // milliseconds

  // Success tracking
  wasSuccessful Boolean @default(false)
  errorMessage  String? @db.Text

  // Timestamps
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([appId])
  @@index([userId, appId])
  @@index([aiAction])
  @@index([createdAt])
  @@index([wasSuccessful])
  @@map("app_ai_usage")
}

// ============================================
// AI Execution Limits (Monthly)
// ============================================

model AIExecutionLimit {
  id              String   @id @default(cuid())

  // User relation
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Monthly tracking
  month           DateTime @default(now()) @db.Date
  executionCount  Int      @default(0)
  maxExecutions   Int      // Based on user's plan tier

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, month])
  @@index([userId, month])
  @@index([month])
  @@map("ai_execution_limits")
}

// ============================================
// System Configuration (Production-ready)
// ============================================

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?  @db.Text
  dataType    ConfigDataType @default(STRING) // STRING, NUMBER, JSON, BOOLEAN
  category    String   // e.g., "trial", "limits", "features", "email"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([key])
  @@map("system_configs")
}

enum ConfigDataType {
  STRING
  NUMBER
  JSON
  BOOLEAN
}

// ============================================
// Published App Analytics
// ============================================

model AppView {
  id          String   @id @default(cuid())

  // App relation
  appId       String
  app         App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  // Visitor info
  visitorIp   String?  // IP address (hashed for privacy)
  userAgent   String?  @db.Text
  referrer    String?  @db.Text

  // Geo/Device data (optional, can be enriched later)
  country     String?
  device      String?  // mobile, desktop, tablet

  // Session tracking
  sessionId   String?  // For tracking unique sessions

  viewedAt    DateTime @default(now())

  @@index([appId])
  @@index([appId, viewedAt])
  @@index([viewedAt])
  @@index([sessionId])
  @@map("app_views")
}
